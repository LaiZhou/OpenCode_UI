# OpenCode Plugin 1.0.4 发布说明

本次更新是插件架构的重大重构，实现了动态插件支持，优化了终端显示体验，并全面提升了代码质量和稳定性。

## 🚀 核心架构升级

### 动态插件支持
- **热重载功能**：插件现在支持热重载，升级或更新后无需重启 IDE，大幅提升开发体验。
- **资源管理优化**：所有服务正确实现 `Disposable` 接口，确保插件卸载时资源完全释放。
- **内存泄漏修复**：解决了 MessageBus 连接泄漏和静态 Map 清理问题，防止插件重载时内存累积。

### 终端显示升级
- **编辑器标签页模式**：OpenCode 终端现在在编辑器区域以标签页形式打开，而非底部面板。
- **更大显示空间**：为 TUI 界面提供更宽敞的显示区域，改善用户体验。
- **自定义编辑器实现**：通过 `FileEditor`、`FileEditorProvider` 等 IntelliJ Platform API 实现专业的编辑器集成。

## 🔧 技术改进

### 内存管理
```kotlin
// 修复前：MessageBus 连接未绑定生命周期
val connection = project.messageBus.connect()

// 修复后：连接绑定到服务生命周期
val connection = project.messageBus.connect(this)
```

### 静态资源清理
```kotlin
// 新增：静态 Map 清理机制
companion object {
    fun clearAll() {
        terminalWidgets.clear()  // 支持动态插件卸载
    }
}
```

### 错误处理增强
- **完整异常捕获**：所有关键操作都添加了适当的异常处理。
- **用户友好提示**：错误发生时提供清晰的错误信息，而非静默失败。
- **详细日志记录**：增加调试日志，便于问题排查。

## 📝 代码质量提升

### 国际化标准
- **纯英文源码**：所有源代码、注释、文档字符串都使用英文。
- **统一编码规范**：遵循 Kotlin 官方编码约定和 IntelliJ Platform 开发指南。
- **开发者文档更新**：在 `AGENTS.md` 中添加了动态插件开发最佳实践。

### 架构文档完善
- **目录结构更新**：新增 `terminal/` 包的完整说明。
- **动态插件指南**：详细的动态插件开发要求和注意事项。
- **最佳实践总结**：MessageBus 连接、资源管理、生命周期管理等。

## 🐛 修复的问题

### 动态插件相关问题
1. **插件卸载失败**：修复了 "PluginMainDescriptor is still loaded" 错误
2. **内存泄漏**：修复了 MessageBus 连接未正确断开导致的内存泄漏
3. **静态资源残留**：修复了静态 Map 在插件卸载时未清理的问题

### 终端相关问题
1. **显示空间不足**：解决了底部面板显示空间受限的问题
2. **编辑器集成**：实现了专业的编辑器标签页集成方案

### 代码质量问题
1. **中文注释**：将所有中文注释转换为英文，符合国际化标准
2. **异常处理**：完善了各模块的异常处理机制

## 🏗️ 技术实现细节

### 新增文件
- `OpenCodeTerminalVirtualFile.kt` - 终端标签页的虚拟文件实现
- `OpenCodeTerminalFileEditor.kt` - 终端编辑器包装器
- `OpenCodeTerminalFileEditorProvider.kt` - 编辑器提供者

### 核心修改
- `OpenCodeService.kt` - 重构为编辑器标签页模式，增强资源管理
- `SessionManager.kt` - 实现 Disposable 接口
- `DiffViewerService.kt` - 修复 MessageBus 连接，转换为英文注释
- `plugin.xml` - 注册 FileEditorProvider 扩展点

### 扩展点配置
```xml
<!-- 新增：文件编辑器提供者 -->
<fileEditorProvider implementation="ai.opencode.ide.jetbrains.terminal.OpenCodeTerminalFileEditorProvider"/>
```

## 📊 兼容性

- **IntelliJ IDEA**: 2024.2+ (Build 242+)
- **Java**: JDK 17+
- **Kotlin**: 2.1.20+
- **动态加载**: 完全支持，无需重启 IDE

## 🎯 用户影响

### 开发者体验
- **更快的开发迭代**：插件更新无需重启 IDE
- **更好的调试体验**：详细日志和错误提示
- **更稳定的运行**：内存泄漏修复，长期运行更稳定

### 终端体验
- **更大的显示区域**：编辑器标签页提供更宽敞的 TUI 显示空间
- **更专业的集成**：与 IDE 编辑器区域完美融合
- **更好的多任务处理**：可以在不同标签页间切换

---

**总结**：1.0.4 版本是插件架构的重要里程碑，不仅解决了动态插件加载的核心技术难题，还显著提升了用户体验和代码质量，为后续功能开发奠定了坚实基础。
