# OpenCode IntelliJ Plugin 1.0.4 更新日志

## 1. 命令行文件引用支持点击跳转（锚链接）

**功能描述**：
OpenCode 终端现在支持识别 `@文件路径#Lx-y` 格式的引用链接。点击这些链接可以直接在 IDE 中打开对应文件，并高亮跳转到指定的行号范围。

**细节与限制**：
- **跳转逻辑**：点击链接时，会在编辑器中打开文件并滚动到对应行。
- **光标行为优化**：为了避免终端输入焦点丢失或光标乱跳，我们在切换回终端标签页时增加了自动复位逻辑，确保光标始终位于输入行的末尾，且处于可输入状态。
- **已知限制**：由于 Jediterm 终端组件的特性，点击历史记录中的链接可能会暂时移动终端内的渲染光标，这是正常现象，不会影响实际命令输入。

## 2. Diff 逻辑深度优化与中文支持修复

**问题描述**：
此前版本中，当 AI 修改中文文件名的文件，或者修改未暂存（Unstaged/Untracked）的文件时，OpenCode Server 可能会返回空的原始内容（Before Content），导致 Diff 界面左侧空白，且“拒绝修改（Reject）”操作会误删文件内容。

**修复细节**：
- **本地快照机制（Baseline Snapshot）**：引入了同步快照机制。在 AI 开始思考（Session Busy）的瞬间，插件会立即捕获所有相关文件的本地状态。无论 Server 返回什么，Diff 显示和 Reject 恢复都优先参考这个本地快照，确保“所见即所得”。
- **中文文件名支持**：修复了 Git 命令在处理中文路径时的转义问题（增加 `-c core.quotepath=false`），确保快照能正确读取中文文件的内容。
- **状态一致性保护**：引入了状态锁（`isCurrentlyBusy`），防止 AI 生成过程中的多次状态更新覆盖原始快照，确保 Diff 对比的始终是用户修改前的版本。
- **LocalHistory 增强**：统一了本地历史记录的标签命名（`OpenCode Modified Before/After`），并在 Reject 操作后自动打标，方便用户追溯和恢复。

## 3. 其他改进与修复

- **会话自动恢复**：新建 Terminal 时现在默认加载最近创建的 Session，无需手动恢复上下文。
- **输入稳定性优化**：改用 TUI API 进行 Prompt 追加，相比模拟键盘输入更稳定。
- **Diff 中文乱码修复**：修复了 Diff 面板中中文内容显示乱码的问题。
- **Windows 路径修复**：修复了 Windows 路径分隔符导致 Diff 面板无法弹出的情况。
- **Tab 拖拽修复**：修复了移动 OpenCode 标签页会导致连接断开或自动关闭的问题。
- **任务完成通知**：当 Session 状态由 Busy 变为 Idle 时，IDE 会弹出系统通知，提示任务已完成。
