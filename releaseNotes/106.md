## 1.0.6

### Diff 功能重构

本版本对 Diff 工作流进行了大规模重构，简化架构并提升可靠性。

#### 架构简化

**DiffEntry 数据模型** (23 行，原 ~80 行)
- 删除冗余字段：`DiffBatch`, `DiffBatchSummary`, `sessionId`, `messageId`, `partId`, `timestamp`
- 新增 `hasUserEdits: Boolean` 字段，直接标记用户是否也编辑了该文件
- 新增 `isNewFile` 计算属性，替代原来分散的判断逻辑

**SessionManager 重写** (299 行，原 ~400 行)
- 清晰的 Turn 生命周期 API：
  - `onTurnStart()`: 创建 LocalHistory 基准，清空状态
  - `onFileEdited(path)`: 记录 AI 编辑的文件
  - `onTurnEnd()`: 标记 turn 结束
  - `processDiffs(serverDiffs)`: 过滤并存储 diff，返回可展示列表
- 异步回调模式：`acceptDiff(entry, callback)` / `rejectDiff(entry, callback)`
- 删除对 `OpenCodeApiClient` 的依赖（不再自己调用 API）
- 删除 `refreshActiveSession()` 等未使用方法

**OpenCodeService 适配**
- `handleEvent()` 使用新的 SessionManager API
- `fetchAndShowDiffs()` 使用 `sessionManager.processDiffs()` 替代手动处理
- 删除私有 `processDiffs()` 方法

**DiffViewerService 简化** (105 行，原 ~150 行)
- 删除单文件 `showDiff()` 方法，统一使用 `showMultiFileDiff()`
- 适配新的 `DiffEntry` 结构 (`entry.file` 代替 `entry.diff.file`)

**OpenCodeDiffEditorActions 更新**
- 使用 `entry.file` 代替 `entry.diff.file`
- 使用 `entry.hasUserEdits` 代替 `sessionManager.hasUserEdits()`
- 使用 `entry.isNewFile` 代替 `entry.diff.before.isEmpty()`

#### 功能改进

- **用户编辑警告**：当用户在 AI 工作期间也编辑了同一文件，Reject 时显示数据丢失警告
- **状态延迟清除**：Accept/Reject 仅在操作成功后才移除 pending diff，避免失败时状态丢失
- **回调在 EDT**：所有 Accept/Reject 回调都在 Event Dispatch Thread 调用，UI 更新更安全

#### 修复

- **Turn 隔离增强 (Strict Isolation)**: 彻底修复了 Turn 2 错误显示 Turn 1 旧 Diff 的问题。现在每轮开始都会强制清空状态，杜绝信号污染。
- **删除 Diff 丢失 (Robust Rescue)**: 修复了删除文件时 Diff 有时消失的 Bug。现在只要能通过 VFS 捕获、LocalHistory 或内存快照找到文件原始内容，就能安全补救。
- **基本修改可见性**: 修复了 Server 信号丢失时，文件修改不显示 Diff 的问题（通过 VFS 强制刷新和亲和力检查）。
- **Ghost Diffs**: 优化了过滤逻辑，确保只有在本轮有明确活动（SSE 声明或 VFS 变动）的文件才显示，消除了僵尸 Diff。

#### 文档

- 更新 `designDocs/diff_feature_plan.md`：新增架构图和 Turn 生命周期说明
- 新增 `designDocs/test_cases.md`：10 个手动测试用例 + 回归检查清单
